{% extends "base.html" %} {% block title %} Blueprint {% endblock %} 
{% block nav_extra %}
<li class="nav-item">
    <span class="help-icon" id="help-trigger" title="Hilfe">?</span>
</li>

<!-- Popup -->
<div id="help-popup" class="help-popup hidden">
    <div class="help-content">
        <span class="close-btn" id="close-help">&times;</span>
        <h2>Hilfe - Montage</h2>
        <p>
            Nehmen Sie einen Klemmbaustein aus dem durch Leuchten markierten Behälter und platzieren Sie diesen wie auf dem Bild zu sehen auf der Montageplatte. Der zu platzierende Klemmbaustein ist in seiner Farbe dargestellt. Die in den vorherigen Schritten zu platzierenden Klemmbausteine sind in schwacher Farbe dargestellt. Über die Knöpfe „Weiter“ und „Zurück“ können Sie zwischen den einzelnen Montageschritten navigieren. Die Navigation kann zudem anhand von Gesten oder Sprache erfolgen (siehe Hilfe im Hauptmenü).
        </p>
    </div>
</div>

{% endblock %}
{% block
content %}
<div class="card">
    <div class="card-body">
        <h1 class="card-title">Add the highlighted Brick - Step {{ step }} of {{ max_steps }}</h1>

        <form
            id="blueprintForm"
            method="post"
            action="{{ url_for('blueprint.blueprint_post') }}"
        >
            <input type="hidden" name="step" value="{{ step }}" />
            <input type="hidden" name="blueprint" value="{{ blueprint }}" />
            <div class="d-flex align-items-center">
                <button
                    type="submit"
                    name="direction"
                    value="back"
                    class="btn btn-secondary py-2 px-4 fs-5 nexttoimage"
                    style="height: 20%; width: 450px"
                >
                    <h1>Zurück</h1>
                </button>

                <div class="text-center flex-grow-1">
                    <image
                        src="data:image/png;base64,{{ image }}"
                        class="image-fluid mx-auto"
                        style="width: 95%; height: auto"
                        id="blueprintImage"
                    />
                </div>

                <button
                    type="submit"
                    name="direction"
                    value="next"
                    class="btn btn-success py-2 px-4 fs-5 nexttoimage"
                    style="height: 80%; width: 450px"
                >
                    <h1>Weiter</h1>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Poll the auto_acknowledge endpoint every second
    function checkAutoAcknowledge() {
        fetch("{{ url_for('blueprint.get_auto_acknowledge') }}")
            .then((response) => response.json())
            .then((data) => {
                if (data.auto_acknowledged === true) {
                    // If auto_acknowledged is true, submit the form with "next" direction
                    const form = document.getElementById("blueprintForm");
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "direction";
                    input.value = "next";
                    form.appendChild(input);
                    form.submit();
                }
            })
            .catch((error) =>
                console.error("Error checking auto acknowledge:", error),
            );
    }

    // Adjust button height to match image
    function adjustButtonHeight() {
        const imageHeight =
            document.getElementById("blueprintImage").clientHeight;
        const buttons = document.querySelectorAll(".btn.nexttoimage");
        buttons.forEach((button) => {
            button.style.height = imageHeight * 1 + "px";
        });
    }

    // Call once when loaded and on window resize
    window.addEventListener("load", adjustButtonHeight);
    window.addEventListener("resize", adjustButtonHeight);

    // Check every second
    setInterval(checkAutoAcknowledge, 500);
</script>
{% endblock %}
